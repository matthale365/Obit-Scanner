<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obituary Scanner - Manual Fixes</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0f172a; --bg-medium: #1e293b; --bg-light: #334155;
            --accent-blue: #3b82f6; --accent-green: #10b981; --accent-orange: #f59e0b; --accent-red: #ef4444;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8; --border: #475569;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        header { text-align: center; padding: 20px; background: var(--bg-medium); border-radius: 12px; margin-bottom: 20px; }
        
        .upload-section { background: var(--bg-medium); border: 2px dashed var(--border); border-radius: 12px; padding: 30px; text-align: center; margin-bottom: 20px; }
        
        .scan-row { background: var(--bg-medium); border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid var(--border); }
        .scan-row-content { display: flex; gap: 20px; }
        .scan-original { flex: 0 0 300px; }
        .scan-original img { width: 100%; border-radius: 8px; border: 1px solid var(--border); }
        
        .scan-splits { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        
        /* The Card */
        .split-card { background: var(--bg-light); border-radius: 8px; padding: 10px; position: relative; transition: transform 0.2s; }
        .split-card img { width: 100%; height: 250px; object-fit: contain; background: #000; border-radius: 4px; margin-bottom: 10px; transition: transform 0.3s ease; }
        
        /* Manual Rotation Controls */
        .card-controls { display: flex; justify-content: center; gap: 8px; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 4px; border: none; cursor: pointer; font-weight: 600; }
        .btn-rotate { background: var(--accent-orange); color: white; }
        .btn-delete { background: var(--accent-red); color: white; }
        
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent-blue); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .status { padding: 10px; border-radius: 6px; margin-bottom: 10px; text-align: center; display: none; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header><h1>üìÑ Obituary Scanner</h1></header>

    <div class="upload-section">
        <input type="file" id="fileInput" multiple accept="image/*">
        <button class="btn-sm" style="padding: 15px 30px; background: var(--accent-blue); color: white; font-size: 1.1rem;" onclick="document.getElementById('fileInput').click()">üì∑ Upload Newspaper Scans</button>
        <p style="margin-top: 10px; color: var(--text-secondary);">If auto-rotation fails, use the orange "Rotate" button on the card.</p>
    </div>

    <div id="statusBox" class="status"></div>
    <div id="scanRowsContainer"></div>
</div>

<script>
    let scheduler = null;
    const WORKER_COUNT = 4;

    async function initTesseract() {
        if (scheduler) return scheduler;
        updateStatus('‚öôÔ∏è Initializing AI Engines...', 'var(--accent-blue)');
        scheduler = Tesseract.createScheduler();
        for (let i = 0; i < WORKER_COUNT; i++) {
            const w = await Tesseract.createWorker('eng');
            await w.setParameters({ tessedit_pageseg_mode: Tesseract.PSM.OSD });
            scheduler.addWorker(w);
        }
        return scheduler;
    }

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;

        const s = await initTesseract();
        updateStatus(`üîç Processing ${files.length} scans...`, 'var(--accent-green)');

        for (const file of files) {
            const rowId = `row-${Date.now()}`;
            const imgData = await readImage(file);
            createRow(rowId, imgData.url, file.name);
            
            // Process individual obituaries
            const splits = await processPage(imgData.canvas, s);
            renderSplits(rowId, splits);
        }
        updateStatus('‚úÖ Ready', 'var(--accent-green)');
    });

    async function processPage(mainCanvas, s) {
        // Simplified Computer Vision to find boxes
        const ctx = mainCanvas.getContext('2d');
        const w = mainCanvas.width, h = mainCanvas.height;
        const boxes = mockFindBoxes(w, h); // This would be your real findCards logic

        const tasks = boxes.map(async (box) => {
            const crop = document.createElement('canvas');
            crop.width = box.w; crop.height = box.h;
            crop.getContext('2d').drawImage(mainCanvas, box.x, box.y, box.w, box.h, 0, 0, box.w, box.h);

            let angle = 0;
            try {
                const { data } = await s.addJob('detect', crop);
                // Only rotate if Tesseract is reasonably confident
                if (data.confidence > 15) {
                    angle = (360 - data.orientation_degrees) % 360;
                }
            } catch (e) {}

            const rotatedCanvas = applyRotation(crop, angle);
            return { url: rotatedCanvas.toDataURL('image/jpeg', 0.8), angle: 0 };
        });

        return Promise.all(tasks);
    }

    function applyRotation(sourceCanvas, degrees) {
        if (degrees === 0) return sourceCanvas;
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        if (degrees === 90 || degrees === 270) {
            c.width = sourceCanvas.height; c.height = sourceCanvas.width;
        } else {
            c.width = sourceCanvas.width; c.height = sourceCanvas.height;
        }
        ctx.translate(c.width/2, c.height/2);
        ctx.rotate(degrees * Math.PI / 180);
        ctx.drawImage(sourceCanvas, -sourceCanvas.width/2, -sourceCanvas.height/2);
        return c;
    }

    // --- MANUAL ROTATION HANDLER ---
    function handleManualRotate(btn) {
        const card = btn.closest('.split-card');
        const img = card.querySelector('img');
        
        // Get current rotation from data attribute or 0
        let currentRot = parseInt(card.dataset.rotation || 0);
        currentRot = (currentRot + 90) % 360;
        card.dataset.rotation = currentRot;

        // Apply CSS transform for instant feedback
        img.style.transform = `rotate(${currentRot}deg)`;
        
        // Note: For final extraction, you'd apply this rotation to the actual canvas/blob
        console.log(`Card manually rotated to ${currentRot}deg`);
    }

    // --- UI HELPERS ---
    function createRow(id, url, name) {
        const html = `
            <div class="scan-row" id="${id}">
                <div style="margin-bottom:10px"><strong>${name}</strong></div>
                <div class="scan-row-content">
                    <div class="scan-original"><img src="${url}"></div>
                    <div class="scan-splits"><div class="spinner"></div></div>
                </div>
            </div>`;
        document.getElementById('scanRowsContainer').insertAdjacentHTML('beforeend', html);
    }

    function renderSplits(rowId, splits) {
        const container = document.querySelector(`#${rowId} .scan-splits`);
        container.innerHTML = splits.map((s, i) => `
            <div class="split-card" data-rotation="0">
                <img src="${s.url}">
                <div class="card-controls">
                    <button class="btn-sm btn-rotate" onclick="handleManualRotate(this)">üîÑ Rotate</button>
                    <button class="btn-sm btn-delete" onclick="this.closest('.split-card').remove()">üóë Remove</button>
                </div>
            </div>
        `).join('');
    }

    function updateStatus(msg, color) {
        const b = document.getElementById('statusBox');
        b.style.display = 'block'; b.style.background = color; b.textContent = msg;
    }

    async function readImage(file) {
        return new Promise(r => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    c.width = img.width; c.height = img.height;
                    c.getContext('2d').drawImage(img,0,0);
                    r({url: e.target.result, canvas: c});
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // Placeholder for your actual box-finding logic
    function mockFindBoxes(w, h) {
        return [
            {x: w*0.1, y: h*0.1, w: w*0.3, h: h*0.4},
            {x: w*0.5, y: h*0.2, w: w*0.3, h: h*0.5}
        ];
    }
</script>
</body>
</html>
